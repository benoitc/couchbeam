name: Test

on:
  push:
    branches: [ master, main ]
  pull_request:
    branches: [ master, main ]

jobs:
  linux:
    name: Linux OTP ${{ matrix.otp }}
    runs-on: ubuntu-22.04

    strategy:
      fail-fast: false
      matrix:
        otp: ['27.3', '28.0']
        rebar3: ['3.25.0']

    steps:
    - uses: actions/checkout@v4

    - name: Setup Erlang/OTP
      uses: erlef/setup-beam@v1
      with:
        otp-version: ${{ matrix.otp }}
        rebar3-version: ${{ matrix.rebar3 }}

    - name: Cache dependencies
      uses: actions/cache@v3
      with:
        path: |
          _build
          ~/.cache/rebar3
        key: linux-otp-${{ matrix.otp }}-${{ hashFiles('rebar.lock') }}
        restore-keys: |
          linux-otp-${{ matrix.otp }}-

    - name: Compile
      run: rebar3 compile

    - name: Run xref
      run: rebar3 xref

    - name: Run tests
      run: rebar3 as test eunit

    - name: Run dialyzer
      run: rebar3 dialyzer

  macos:
    name: macOS OTP ${{ matrix.otp }}
    runs-on: macos-latest

    strategy:
      fail-fast: false
      matrix:
        otp: ['27.3', '28.0']
        rebar3: ['3.25.0']

    steps:
    - uses: actions/checkout@v4

    - name: Setup Erlang/OTP
      uses: erlef/setup-beam@v1
      with:
        otp-version: ${{ matrix.otp }}
        rebar3-version: ${{ matrix.rebar3 }}

    - name: Cache dependencies
      uses: actions/cache@v3
      with:
        path: |
          _build
          ~/.cache/rebar3
        key: macos-otp-${{ matrix.otp }}-${{ hashFiles('rebar.lock') }}
        restore-keys: |
          macos-otp-${{ matrix.otp }}-

    - name: Compile
      run: rebar3 compile

    - name: Run xref
      run: rebar3 xref

    - name: Run tests
      run: rebar3 as test eunit

    - name: Run dialyzer
      run: rebar3 dialyzer

  freebsd:
    name: FreeBSD 14.2 OTP-28
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Test on FreeBSD
      uses: vmactions/freebsd-vm@v1
      with:
        release: "14.2"
        usesh: true
        prepare: |
          pkg install -y erlang-runtime28 rebar3 cmake git gmake go llvm18
        run: |
          # Ensure Erlang 28 is in PATH
          export PATH="/usr/local/lib/erlang28/bin:$PATH"
          # Use LLVM 18 clang which fully supports C++20
          export CC=/usr/local/bin/clang18
          export CXX=/usr/local/bin/clang++18
          git config --global --add safe.directory $GITHUB_WORKSPACE
          rebar3 compile
          rebar3 xref
          rebar3 as test eunit

  # Optional integration tests with real CouchDB
  integration:
    name: Integration Tests (CouchDB)
    runs-on: ubuntu-22.04
    # This job is optional - don't block CI if it fails
    continue-on-error: true

    services:
      couchdb:
        image: couchdb:3.3
        env:
          COUCHDB_USER: admin
          COUCHDB_PASSWORD: admin
        ports:
          - 5984:5984
        options: >-
          --health-cmd "curl -f http://localhost:5984/_up || exit 1"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
    - uses: actions/checkout@v4

    - name: Setup Erlang/OTP
      uses: erlef/setup-beam@v1
      with:
        otp-version: '27.3'
        rebar3-version: '3.25.0'

    - name: Cache dependencies
      uses: actions/cache@v3
      with:
        path: |
          _build
          ~/.cache/rebar3
        key: integration-otp-27-${{ hashFiles('rebar.lock') }}
        restore-keys: |
          integration-otp-27-

    - name: Compile
      run: rebar3 compile

    - name: Wait for CouchDB and initialize
      run: |
        until curl -sf http://localhost:5984/_up; do
          echo "Waiting for CouchDB..."
          sleep 2
        done
        echo "CouchDB is ready"
        # Create system databases required for full functionality
        curl -X PUT http://admin:admin@localhost:5984/_users
        curl -X PUT http://admin:admin@localhost:5984/_replicator
        curl -X PUT http://admin:admin@localhost:5984/_global_changes
        echo "System databases created"

    - name: Run integration tests
      env:
        COUCHDB_URL: http://localhost:5984
        COUCHDB_USER: admin
        COUCHDB_PASS: admin
      run: |
        # Run each test group individually for better isolation
        for group in server_ops database_ops document_ops bulk_ops attachment_ops \
                     view_streaming_ops changes_streaming_ops replication_ops \
                     db_management_ops mango_ops uuid_ops; do
          echo "=== Running $group ==="
          rebar3 ct --suite=couchbeam_integration_SUITE --group=$group --readable=true || exit 1
        done
        echo "All integration tests passed"
